var _scriptName="d3pie",_version="0.1.6",_uniqueIDCounter=0,defaultSettings={header:{title:{text:"",color:"#333333",fontSize:18,font:"arial"},subtitle:{text:"",color:"#666666",fontSize:14,font:"arial"},location:"top-center",titleSubtitlePadding:8},footer:{text:"",color:"#666666",fontSize:14,font:"arial",location:"left"},size:{canvasHeight:500,canvasWidth:500,pieInnerRadius:"0%",pieOuterRadius:null},data:{sortOrder:"none",ignoreSmallSegments:{enabled:!1,valueType:"percentage",value:null},smallSegmentGrouping:{enabled:!1,value:1,valueType:"percentage",label:"Other",color:"#cccccc"},content:[]},labels:{outer:{format:"label",hideWhenLessThanPercentage:null,pieDistance:30},inner:{format:"percentage",hideWhenLessThanPercentage:null},mainLabel:{color:"#333333",font:"arial",fontSize:10},percentage:{color:"#dddddd",font:"arial",fontSize:10,decimalPlaces:0},value:{color:"#cccc44",font:"arial",fontSize:10},lines:{enabled:!0,style:"curved",color:"segment"},truncation:{enabled:!1,truncateLength:30},formatter:null},effects:{load:{effect:"default",speed:1e3},pullOutSegmentOnClick:{effect:"bounce",speed:300,size:10},highlightSegmentOnMouseover:!0,highlightLuminosity:-.2},tooltips:{enabled:!1,type:"placeholder",string:"",placeholderParser:null,styles:{fadeInSpeed:250,backgroundColor:"#000000",backgroundOpacity:.5,color:"#efefef",borderRadius:2,font:"arial",fontSize:10,padding:4}},misc:{colors:{background:null,segments:["#2484c1","#65a620","#7b6888","#a05d56","#961a1a","#d8d23a","#e98125","#d0743c","#635222","#6ada6a","#0c6197","#7d9058","#207f33","#44b9b0","#bca44a","#e4a14b","#a3acb2","#8cc3e9","#69a6f9","#5b388f","#546e91","#8bde95","#d2ab58","#273c71","#98bf6e","#4daa4b","#98abc5","#cc1010","#31383b","#006391","#c2643f","#b0a474","#a5a39c","#a9c2bc","#22af8c","#7fcecf","#987ac6","#3d3b87","#b77b1c","#c9c2b6","#807ece","#8db27c","#be66a2","#9ed3c6","#00644b","#005064","#77979f","#77e079","#9c73ab","#1f79a7"],segmentStroke:"#ffffff"},gradient:{enabled:!1,percentage:95,color:"#000000"},canvasPadding:{top:5,right:5,bottom:5,left:5},pieCenterOffset:{x:0,y:0},cssPrefix:null},callbacks:{onload:null,onMouseoverSegment:null,onMouseoutSegment:null,onClickSegment:null}},validate={initialCheck:function(e){var t=e.cssPrefix,n=e.element,o=e.options
if(!window.d3||!window.d3.hasOwnProperty("version"))return console.error("d3pie error: d3 is not available"),!1
if(!(n instanceof HTMLElement||n instanceof SVGElement))return console.error("d3pie error: the first d3pie() param must be a valid DOM element (not jQuery) or a ID string."),!1
if(!/[a-zA-Z][a-zA-Z0-9_-]*$/.test(t))return console.error("d3pie error: invalid options.misc.cssPrefix"),!1
if(!helpers.isArray(o.data.content))return console.error("d3pie error: invalid config structure: missing data.content property."),!1
if(0===o.data.content.length)return console.error("d3pie error: no data supplied."),!1
for(var s=[],a=0;a<o.data.content.length;a++)"number"!=typeof o.data.content[a].value||isNaN(o.data.content[a].value)?console.log("not valid: ",o.data.content[a]):o.data.content[a].value<=0?console.log("not valid - should have positive value: ",o.data.content[a]):s.push(o.data.content[a])
return e.options.data.content=s,!0}},helpers={addSVGSpace:function(e){var t=e.element,n=e.options.size.canvasWidth,o=e.options.size.canvasHeight,s=e.options.misc.colors.background,a=d3.select(t).append("svg:svg").attr("width",n).attr("height",o)
return"transparent"!==s&&a.style("background-color",function(){return s}),a},whenIdExists:function(e,t){var n=1,o=1e3,s=setInterval(function(){document.getElementById(e)&&(clearInterval(s),t()),n>o&&clearInterval(s),n++},1)},whenElementsExist:function(e,t){var n=1,o=1e3,s=setInterval(function(){for(var a=!0,i=0;i<e.length;i++)if(!document.getElementById(e[i])){a=!1
break}a&&(clearInterval(s),t()),n>o&&clearInterval(s),n++},1)},shuffleArray:function(e){for(var t,n,o=e.length;0!==o;)n=Math.floor(Math.random()*o),o-=1,t=e[o],e[o]=e[n],e[n]=t
return e},processObj:function(e,t,n){return"string"==typeof t?helpers.processObj(e,t.split("."),n):1===t.length&&void 0!==n?(e[t[0]]=n,e[t[0]]):0===t.length?e:helpers.processObj(e[t[0]],t.slice(1),n)},getDimensions:function(e){var t=document.getElementById(e),n=0,o=0
if(t){var s=t.getBBox()
n=s.width,o=s.height}else console.log("error: getDimensions() "+e+" not found.")
return{w:n,h:o}},rectIntersect:function(e,t){var n=t.x>e.x+e.w||t.x+t.w<e.x||t.y+t.h<e.y||t.y>e.y+e.h
return!n},getColorShade:function(e,t){e=String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0
for(var n="#",o=0;3>o;o++){var s=parseInt(e.substr(2*o,2),16)
s=Math.round(Math.min(Math.max(0,s+s*t),255)).toString(16),n+=("00"+s).substr(s.length)}return n},initSegmentColors:function(e){for(var t=e.options.data.content,n=e.options.misc.colors.segments,o=[],s=0;s<t.length;s++)t[s].hasOwnProperty("color")?o.push(t[s].color):o.push(n[s])
return o},applySmallSegmentGrouping:function(e,t){var n
"percentage"===t.valueType&&(n=math.getTotalPieSize(e))
for(var o=[],s=[],a=0,i=0;i<e.length;i++)if("percentage"===t.valueType){var r=e[i].value/n*100
if(r<=t.value){s.push(e[i]),a+=e[i].value
continue}e[i].isGrouped=!1,o.push(e[i])}else{if(e[i].value<=t.value){s.push(e[i]),a+=e[i].value
continue}e[i].isGrouped=!1,o.push(e[i])}return s.length&&o.push({color:t.color,label:t.label,value:a,isGrouped:!0,groupedData:s}),o},showPoint:function(e,t,n){e.append("circle").attr("cx",t).attr("cy",n).attr("r",2).style("fill","black")},isFunction:function(e){var t={}
return e&&"[object Function]"===t.toString.call(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)}},extend=function(){var e,t,n,o,s,a,i=arguments[0]||{},r=1,l=arguments.length,c=!1,u=Object.prototype.toString,p=Object.prototype.hasOwnProperty,d={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},f={isFunction:function(e){return"function"===f.type(e)},isArray:Array.isArray||function(e){return"array"===f.type(e)},isWindow:function(e){return null!==e&&e===e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null===e?String(e):d[u.call(e)]||"object"},isPlainObject:function(e){if(!e||"object"!==f.type(e)||e.nodeType)return!1
try{if(e.constructor&&!p.call(e,"constructor")&&!p.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var n
for(n in e);return void 0===n||p.call(e,n)}}
for("boolean"==typeof i&&(c=i,i=arguments[1]||{},r=2),"object"==typeof i||f.isFunction(i)||(i={}),l===r&&(i=this,--r),r;l>r;r++)if(null!==(e=arguments[r]))for(t in e)n=i[t],o=e[t],i!==o&&(c&&o&&(f.isPlainObject(o)||(s=f.isArray(o)))?(s?(s=!1,a=n&&f.isArray(n)?n:[]):a=n&&f.isPlainObject(n)?n:{},i[t]=extend(c,a,o)):void 0!==o&&(i[t]=o))
return i},math={toRadians:function(e){return e*(Math.PI/180)},toDegrees:function(e){return e*(180/Math.PI)},computePieRadius:function(e){var t=e.options.size,n=e.options.misc.canvasPadding,o=t.canvasWidth-n.left-n.right,s=t.canvasHeight-n.top-n.bottom
"pie-center"!==e.options.header.location&&(s-=e.textComponents.headerHeight),e.textComponents.footer.exists&&(s-=e.textComponents.footer.h),s=0>s?0:s
var a,i,r=(s>o?o:s)/3
if(null!==t.pieOuterRadius)if(/%/.test(t.pieOuterRadius)){i=parseInt(t.pieOuterRadius.replace(/[\D]/,""),10),i=i>99?99:i,i=0>i?0:i
var l=s>o?o:s
if("none"!==e.options.labels.outer.format){var c=2*parseInt(e.options.labels.outer.pieDistance,10)
l-c>0&&(l-=c)}r=Math.floor(l/100*i)/2}else r=parseInt(t.pieOuterRadius,10);/%/.test(t.pieInnerRadius)?(i=parseInt(t.pieInnerRadius.replace(/[\D]/,""),10),i=i>99?99:i,i=0>i?0:i,a=Math.floor(r/100*i)):a=parseInt(t.pieInnerRadius,10),e.innerRadius=a,e.outerRadius=r},getTotalPieSize:function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n].value
return t},sortPieData:function(e){var t=e.options.data.content,n=e.options.data.sortOrder
switch(n){case"none":break
case"random":t=helpers.shuffleArray(t)
break
case"value-asc":t.sort(function(e,t){return e.value<t.value?-1:1})
break
case"value-desc":t.sort(function(e,t){return e.value<t.value?1:-1})
break
case"label-asc":t.sort(function(e,t){return e.label.toLowerCase()>t.label.toLowerCase()?1:-1})
break
case"label-desc":t.sort(function(e,t){return e.label.toLowerCase()<t.label.toLowerCase()?1:-1})}return t},getPieTranslateCenter:function(e){return"translate("+e.x+","+e.y+")"},calculatePieCenter:function(e){var t=e.options.misc.pieCenterOffset,n=e.textComponents.title.exists&&"pie-center"!==e.options.header.location,o=e.textComponents.subtitle.exists&&"pie-center"!==e.options.header.location,s=e.options.misc.canvasPadding.top
n&&o?s+=e.textComponents.title.h+e.options.header.titleSubtitlePadding+e.textComponents.subtitle.h:n?s+=e.textComponents.title.h:o&&(s+=e.textComponents.subtitle.h)
var a=0
e.textComponents.footer.exists&&(a=e.textComponents.footer.h+e.options.misc.canvasPadding.bottom)
var i=(e.options.size.canvasWidth-e.options.misc.canvasPadding.left-e.options.misc.canvasPadding.right)/2+e.options.misc.canvasPadding.left,r=(e.options.size.canvasHeight-a-s)/2+s
i+=t.x,r+=t.y,e.pieCenter={x:i,y:r}},rotate:function(e,t,n,o,s){s=s*Math.PI/180
var a=Math.cos,i=Math.sin,r=(e-n)*a(s)-(t-o)*i(s)+n,l=(e-n)*i(s)+(t-o)*a(s)+o
return{x:r,y:l}},translate:function(e,t,n,o){var s=math.toRadians(o)
return{x:e+n*Math.sin(s),y:t-n*Math.cos(s)}},pointIsInArc:function(e,t,n){var o=n.innerRadius()(t),s=n.outerRadius()(t),a=n.startAngle()(t),i=n.endAngle()(t),r=e.x*e.x+e.y*e.y,l=Math.atan2(e.x,-e.y)
return l=0>l?l+2*Math.PI:l,r>=o*o&&s*s>=r&&l>=a&&i>=l}},labels={add:function(e,t,n){var o=labels.getIncludes(n),s=e.options.labels,a=e.svg.insert("g","."+e.cssPrefix+"labels-"+t).attr("class",e.cssPrefix+"labels-"+t),i=a.selectAll("."+e.cssPrefix+"labelGroup-"+t).data(e.options.data.content).enter().append("g").attr("id",function(n,o){return e.cssPrefix+"labelGroup"+o+"-"+t}).attr("data-index",function(e,t){return t}).attr("class",e.cssPrefix+"labelGroup-"+t).style("opacity",0),r={section:t,sectionDisplayType:n}
o.mainLabel&&i.append("text").attr("id",function(n,o){return e.cssPrefix+"segmentMainLabel"+o+"-"+t}).attr("class",e.cssPrefix+"segmentMainLabel-"+t).text(function(e,t){var n=e.label
return s.formatter?(r.index=t,r.part="mainLabel",r.value=e.value,r.label=n,n=s.formatter(r)):s.truncation.enabled&&e.label.length>s.truncation.truncateLength&&(n=e.label.substring(0,s.truncation.truncateLength)+"..."),n}).style("font-size",s.mainLabel.fontSize+"px").style("font-family",s.mainLabel.font).style("fill",s.mainLabel.color),o.percentage&&i.append("text").attr("id",function(n,o){return e.cssPrefix+"segmentPercentage"+o+"-"+t}).attr("class",e.cssPrefix+"segmentPercentage-"+t).text(function(t,n){var o=segments.getPercentage(e,n,e.options.labels.percentage.decimalPlaces)
return s.formatter?(r.index=n,r.part="percentage",r.value=t.value,r.label=o,o=s.formatter(r)):o+="%",o}).style("font-size",s.percentage.fontSize+"px").style("font-family",s.percentage.font).style("fill",s.percentage.color),o.value&&i.append("text").attr("id",function(n,o){return e.cssPrefix+"segmentValue"+o+"-"+t}).attr("class",e.cssPrefix+"segmentValue-"+t).text(function(e,t){return r.index=t,r.part="value",r.value=e.value,r.label=e.value,s.formatter?s.formatter(r,e.value):e.value}).style("font-size",s.value.fontSize+"px").style("font-family",s.value.font).style("fill",s.value.color)},positionLabelElements:function(e,t,n){labels["dimensions-"+t]=[]
var o=d3.selectAll("."+e.cssPrefix+"labelGroup-"+t)
o.each(function(n,o){var s=d3.select(this).selectAll("."+e.cssPrefix+"segmentMainLabel-"+t),a=d3.select(this).selectAll("."+e.cssPrefix+"segmentPercentage-"+t),i=d3.select(this).selectAll("."+e.cssPrefix+"segmentValue-"+t)
labels["dimensions-"+t].push({mainLabel:null!==s.node()?s.node().getBBox():null,percentage:null!==a.node()?a.node().getBBox():null,value:null!==i.node()?i.node().getBBox():null})})
var s=5,a=labels["dimensions-"+t]
switch(n){case"label-value1":d3.selectAll("."+e.cssPrefix+"segmentValue-"+t).attr("dx",function(e,t){return a[t].mainLabel.width+s})
break
case"label-value2":d3.selectAll("."+e.cssPrefix+"segmentValue-"+t).attr("dy",function(e,t){return a[t].mainLabel.height})
break
case"label-percentage1":d3.selectAll("."+e.cssPrefix+"segmentPercentage-"+t).attr("dx",function(e,t){return a[t].mainLabel.width+s})
break
case"label-percentage2":d3.selectAll("."+e.cssPrefix+"segmentPercentage-"+t).attr("dx",function(e,t){return a[t].mainLabel.width/2-a[t].percentage.width/2}).attr("dy",function(e,t){return a[t].mainLabel.height})}},computeLabelLinePositions:function(e){e.lineCoordGroups=[],d3.selectAll("."+e.cssPrefix+"labelGroup-outer").each(function(t,n){return labels.computeLinePosition(e,n)})},computeLinePosition:function(e,t){var n,o,s,a,i=segments.getSegmentAngle(t,e.options.data.content,e.totalSize,{midpoint:!0}),r=math.rotate(e.pieCenter.x,e.pieCenter.y-e.outerRadius,e.pieCenter.x,e.pieCenter.y,i),l=e.outerLabelGroupData[t].h/5,c=6,u=Math.floor(i/90),p=4
switch(2===u&&180===i&&(u=1),u){case 0:n=e.outerLabelGroupData[t].x-c-(e.outerLabelGroupData[t].x-c-r.x)/2,o=e.outerLabelGroupData[t].y+(r.y-e.outerLabelGroupData[t].y)/p,s=e.outerLabelGroupData[t].x-c,a=e.outerLabelGroupData[t].y-l
break
case 1:n=r.x+(e.outerLabelGroupData[t].x-r.x)/p,o=r.y+(e.outerLabelGroupData[t].y-r.y)/p,s=e.outerLabelGroupData[t].x-c,a=e.outerLabelGroupData[t].y-l
break
case 2:var d=e.outerLabelGroupData[t].x+e.outerLabelGroupData[t].w+c
n=r.x-(r.x-d)/p,o=r.y+(e.outerLabelGroupData[t].y-r.y)/p,s=e.outerLabelGroupData[t].x+e.outerLabelGroupData[t].w+c,a=e.outerLabelGroupData[t].y-l
break
case 3:var f=e.outerLabelGroupData[t].x+e.outerLabelGroupData[t].w+c
n=f+(r.x-f)/p,o=e.outerLabelGroupData[t].y+(r.y-e.outerLabelGroupData[t].y)/p,s=e.outerLabelGroupData[t].x+e.outerLabelGroupData[t].w+c,a=e.outerLabelGroupData[t].y-l}"straight"===e.options.labels.lines.style?e.lineCoordGroups[t]=[{x:r.x,y:r.y},{x:s,y:a}]:e.lineCoordGroups[t]=[{x:r.x,y:r.y},{x:n,y:o},{x:s,y:a}]},addLabelLines:function(e){var t=e.svg.insert("g","."+e.cssPrefix+"pieChart").attr("class",e.cssPrefix+"lineGroups").style("opacity",0),n=t.selectAll("."+e.cssPrefix+"lineGroup").data(e.lineCoordGroups).enter().append("g").attr("class",e.cssPrefix+"lineGroup"),o=d3.svg.line().interpolate("basis").x(function(e){return e.x}).y(function(e){return e.y})
n.append("path").attr("d",o).attr("stroke",function(t,n){return"segment"===e.options.labels.lines.color?e.options.colors[n]:e.options.labels.lines.color}).attr("stroke-width",1).attr("fill","none").style("opacity",function(t,n){var o=e.options.labels.outer.hideWhenLessThanPercentage,s=segments.getPercentage(e,n,e.options.labels.percentage.decimalPlaces),a=null!==o&&o>s||""===e.options.data.content[n].label
return a?0:1})},positionLabelGroups:function(e,t){"none"!==e.options.labels[t].format&&d3.selectAll("."+e.cssPrefix+"labelGroup-"+t).style("opacity",0).attr("transform",function(n,o){var s,a
if("outer"===t)s=e.outerLabelGroupData[o].x,a=e.outerLabelGroupData[o].y
else{var i=extend(!0,{},e.pieCenter)
if(e.innerRadius>0){var r=segments.getSegmentAngle(o,e.options.data.content,e.totalSize,{midpoint:!0}),l=math.translate(e.pieCenter.x,e.pieCenter.y,e.innerRadius,r)
i.x=l.x,i.y=l.y}var c=helpers.getDimensions(e.cssPrefix+"labelGroup"+o+"-inner"),u=c.w/2,p=c.h/4
s=i.x+(e.lineCoordGroups[o][0].x-i.x)/1.8,a=i.y+(e.lineCoordGroups[o][0].y-i.y)/1.8,s-=u,a+=p}return"translate("+s+","+a+")"})},fadeInLabelsAndLines:function(e){var t="default"===e.options.effects.load.effect?e.options.effects.load.speed:1
setTimeout(function(){var t="default"===e.options.effects.load.effect?400:1
d3.selectAll("."+e.cssPrefix+"labelGroup-outer").transition().duration(t).style("opacity",function(t,n){var o=e.options.labels.outer.hideWhenLessThanPercentage,s=segments.getPercentage(e,n,e.options.labels.percentage.decimalPlaces)
return null!==o&&o>s?0:1}),d3.selectAll("."+e.cssPrefix+"labelGroup-inner").transition().duration(t).style("opacity",function(t,n){var o=e.options.labels.inner.hideWhenLessThanPercentage,s=segments.getPercentage(e,n,e.options.labels.percentage.decimalPlaces)
return null!==o&&o>s?0:1}),d3.selectAll("g."+e.cssPrefix+"lineGroups").transition().duration(t).style("opacity",1),helpers.isFunction(e.options.callbacks.onload)&&setTimeout(function(){try{e.options.callbacks.onload()}catch(t){}},t)},t)},getIncludes:function(e){var t=!1,n=!1,o=!1
switch(e){case"label":t=!0
break
case"value":n=!0
break
case"percentage":o=!0
break
case"label-value1":case"label-value2":t=!0,n=!0
break
case"label-percentage1":case"label-percentage2":t=!0,o=!0}return{mainLabel:t,value:n,percentage:o}},computeOuterLabelCoords:function(e){e.svg.selectAll("."+e.cssPrefix+"labelGroup-outer").each(function(t,n){return labels.getIdealOuterLabelPositions(e,n)}),labels.resolveOuterLabelCollisions(e)},resolveOuterLabelCollisions:function(e){if("none"!==e.options.labels.outer.format){var t=e.options.data.content.length
labels.checkConflict(e,0,"clockwise",t),labels.checkConflict(e,t-1,"anticlockwise",t)}},checkConflict:function(e,t,n,o){var s,a
if(!(1>=o)){var i=e.outerLabelGroupData[t].hs
if(!("clockwise"===n&&"right"!==i||"anticlockwise"===n&&"left"!==i)){var r="clockwise"===n?t+1:t-1,l=e.outerLabelGroupData[t],c=e.outerLabelGroupData[r],u={labelHeights:e.outerLabelGroupData[0].h,center:e.pieCenter,lineLength:e.outerRadius+e.options.labels.outer.pieDistance,heightChange:e.outerLabelGroupData[0].h+1}
if("clockwise"===n){for(s=0;t>=s;s++)if(a=e.outerLabelGroupData[s],helpers.rectIntersect(a,c)){labels.adjustLabelPos(e,r,l,u)
break}}else for(s=o-1;s>=t;s--)if(a=e.outerLabelGroupData[s],helpers.rectIntersect(a,c)){labels.adjustLabelPos(e,r,l,u)
break}labels.checkConflict(e,r,n,o)}}},adjustLabelPos:function(e,t,n,o){var s,a,i,r
r=n.y+o.heightChange,a=o.center.y-r,s=Math.abs(o.lineLength)>Math.abs(a)?Math.sqrt(o.lineLength*o.lineLength-a*a):Math.sqrt(a*a-o.lineLength*o.lineLength),i="right"===n.hs?o.center.x+s:o.center.x-s-e.outerLabelGroupData[t].w,e.outerLabelGroupData[t].x=i,e.outerLabelGroupData[t].y=r},getIdealOuterLabelPositions:function(e,t){var n=d3.select("#"+e.cssPrefix+"labelGroup"+t+"-outer").node()
if(n){var o=n.getBBox(),s=segments.getSegmentAngle(t,e.options.data.content,e.totalSize,{midpoint:!0}),a=e.pieCenter.x,i=e.pieCenter.y-(e.outerRadius+e.options.labels.outer.pieDistance),r=math.rotate(a,i,e.pieCenter.x,e.pieCenter.y,s),l="right"
s>180?(r.x-=o.width+8,l="left"):r.x+=8,e.outerLabelGroupData[t]={x:r.x,y:r.y,w:o.width,h:o.height,hs:l}}}},segments={create:function(e){var t=e.pieCenter,n=e.options.colors,o=e.options.effects.load,s=e.options.misc.colors.segmentStroke,a=e.svg.insert("g","#"+e.cssPrefix+"title").attr("transform",function(){return math.getPieTranslateCenter(t)}).attr("class",e.cssPrefix+"pieChart"),i=d3.svg.arc().innerRadius(e.innerRadius).outerRadius(e.outerRadius).startAngle(0).endAngle(function(t){return t.value/e.totalSize*2*Math.PI}),r=a.selectAll("."+e.cssPrefix+"arc").data(e.options.data.content).enter().append("g").attr("class",e.cssPrefix+"arc"),l=o.speed
"none"===o.effect&&(l=0),r.append("path").attr("id",function(t,n){return e.cssPrefix+"segment"+n}).attr("fill",function(t,o){var s=n[o]
return e.options.misc.gradient.enabled&&(s="url(#"+e.cssPrefix+"grad"+o+")"),s}).style("stroke",s).style("stroke-width",1).transition().ease("cubic-in-out").duration(l).attr("data-index",function(e,t){return t}).attrTween("d",function(t){var n=d3.interpolate({value:0},t)
return function(t){return e.arc(n(t))}}),e.svg.selectAll("g."+e.cssPrefix+"arc").attr("transform",function(t,n){var o=0
return n>0&&(o=segments.getSegmentAngle(n-1,e.options.data.content,e.totalSize)),"rotate("+o+")"}),e.arc=i},addGradients:function(e){var t=e.svg.append("defs").selectAll("radialGradient").data(e.options.data.content).enter().append("radialGradient").attr("gradientUnits","userSpaceOnUse").attr("cx",0).attr("cy",0).attr("r","120%").attr("id",function(t,n){return e.cssPrefix+"grad"+n})
t.append("stop").attr("offset","0%").style("stop-color",function(t,n){return e.options.colors[n]}),t.append("stop").attr("offset",e.options.misc.gradient.percentage+"%").style("stop-color",e.options.misc.gradient.color)},addSegmentEventHandlers:function(e){var t=d3.selectAll("."+e.cssPrefix+"arc,."+e.cssPrefix+"labelGroup-inner,."+e.cssPrefix+"labelGroup-outer")
t.on("click",function(){var t,n=d3.select(this)
if(n.attr("class")===e.cssPrefix+"arc")t=n.select("path")
else{var o=n.attr("data-index")
t=d3.select("#"+e.cssPrefix+"segment"+o)}var s=t.attr("class")===e.cssPrefix+"expanded"
segments.onSegmentEvent(e,e.options.callbacks.onClickSegment,t,s),"none"!==e.options.effects.pullOutSegmentOnClick.effect&&(s?segments.closeSegment(e,t.node()):segments.openSegment(e,t.node()))}),t.on("mouseover",function(){var t,n,o=d3.select(this)
if(o.attr("class")===e.cssPrefix+"arc"?t=o.select("path"):(n=o.attr("data-index"),t=d3.select("#"+e.cssPrefix+"segment"+n)),e.options.effects.highlightSegmentOnMouseover){n=t.attr("data-index")
var s=e.options.colors[n]
t.style("fill",helpers.getColorShade(s,e.options.effects.highlightLuminosity))}e.options.tooltips.enabled&&(n=t.attr("data-index"),tt.showTooltip(e,n))
var a=t.attr("class")===e.cssPrefix+"expanded"
segments.onSegmentEvent(e,e.options.callbacks.onMouseoverSegment,t,a)}),t.on("mousemove",function(){tt.moveTooltip(e)}),t.on("mouseout",function(){var t,n,o=d3.select(this)
if(o.attr("class")===e.cssPrefix+"arc"?t=o.select("path"):(n=o.attr("data-index"),t=d3.select("#"+e.cssPrefix+"segment"+n)),e.options.effects.highlightSegmentOnMouseover){n=t.attr("data-index")
var s=e.options.colors[n]
e.options.misc.gradient.enabled&&(s="url(#"+e.cssPrefix+"grad"+n+")"),t.style("fill",s)}e.options.tooltips.enabled&&(n=t.attr("data-index"),tt.hideTooltip(e,n))
var a=t.attr("class")===e.cssPrefix+"expanded"
segments.onSegmentEvent(e,e.options.callbacks.onMouseoutSegment,t,a)})},onSegmentEvent:function(e,t,n,o){if(helpers.isFunction(t)){var s=parseInt(n.attr("data-index"),10)
t({segment:n.node(),index:s,expanded:o,data:e.options.data.content[s]})}},openSegment:function(e,t){e.isOpeningSegment||(e.isOpeningSegment=!0,d3.selectAll("."+e.cssPrefix+"expanded").length>0&&segments.closeSegment(e,d3.select("."+e.cssPrefix+"expanded").node()),d3.select(t).transition().ease(e.options.effects.pullOutSegmentOnClick.effect).duration(e.options.effects.pullOutSegmentOnClick.speed).attr("transform",function(t,n){var o=e.arc.centroid(t),s=o[0],a=o[1],i=Math.sqrt(s*s+a*a),r=parseInt(e.options.effects.pullOutSegmentOnClick.size,10)
return"translate("+s/i*r+","+a/i*r+")"}).each("end",function(n,o){e.currentlyOpenSegment=t,e.isOpeningSegment=!1,d3.select(this).attr("class",e.cssPrefix+"expanded")}))},closeSegment:function(e,t){d3.select(t).transition().duration(400).attr("transform","translate(0,0)").each("end",function(t,n){d3.select(this).attr("class",""),e.currentlyOpenSegment=null})},getCentroid:function(e){var t=e.getBBox()
return{x:t.x+t.width/2,y:t.y+t.height/2}},getSegmentAngle:function(e,t,n,o){var s,a=extend({compounded:!0,midpoint:!1},o),i=t[e].value
if(a.compounded){s=0
for(var r=0;e>=r;r++)s+=t[r].value}"undefined"==typeof s&&(s=i)
var l=s/n*360
if(a.midpoint){var c=i/n*360
l-=c/2}return l},getPercentage:function(e,t,n){var o=e.options.data.content[t].value/e.totalSize
return 0>=n?Math.round(100*o):(100*o).toFixed(n)}},text={offscreenCoord:-1e4,addTitle:function(e){e.svg.selectAll("."+e.cssPrefix+"title").data([e.options.header.title]).enter().append("text").text(function(e){return e.text}).attr({id:e.cssPrefix+"title","class":e.cssPrefix+"title",x:text.offscreenCoord,y:text.offscreenCoord}).attr("text-anchor",function(){var t
return t="top-center"===e.options.header.location||"pie-center"===e.options.header.location?"middle":"left"}).attr("fill",function(e){return e.color}).style("font-size",function(e){return e.fontSize+"px"}).style("font-family",function(e){return e.font})},positionTitle:function(e){var t,n=e.textComponents,o=e.options.header.location,s=e.options.misc.canvasPadding,a=e.options.size.canvasWidth,i=e.options.header.titleSubtitlePadding
t="top-left"===o?s.left:(a-s.right)/2+s.left,t+=e.options.misc.pieCenterOffset.x
var r=s.top+n.title.h
if("pie-center"===o)if(r=e.pieCenter.y,n.subtitle.exists){var l=n.title.h+i+n.subtitle.h
r=r-l/2+n.title.h}else r+=n.title.h/4
e.svg.select("#"+e.cssPrefix+"title").attr("x",t).attr("y",r)},addSubtitle:function(e){var t=e.options.header.location
e.svg.selectAll("."+e.cssPrefix+"subtitle").data([e.options.header.subtitle]).enter().append("text").text(function(e){return e.text}).attr("x",text.offscreenCoord).attr("y",text.offscreenCoord).attr("id",e.cssPrefix+"subtitle").attr("class",e.cssPrefix+"subtitle").attr("text-anchor",function(){var e
return e="top-center"===t||"pie-center"===t?"middle":"left"}).attr("fill",function(e){return e.color}).style("font-size",function(e){return e.fontSize+"px"}).style("font-family",function(e){return e.font})},positionSubtitle:function(e){var t,n=e.options.misc.canvasPadding,o=e.options.size.canvasWidth
t="top-left"===e.options.header.location?n.left:(o-n.right)/2+n.left,t+=e.options.misc.pieCenterOffset.x
var s=text.getHeaderHeight(e)
e.svg.select("#"+e.cssPrefix+"subtitle").attr("x",t).attr("y",s)},addFooter:function(e){e.svg.selectAll("."+e.cssPrefix+"footer").data([e.options.footer]).enter().append("text").text(function(e){return e.text}).attr("x",text.offscreenCoord).attr("y",text.offscreenCoord).attr("id",e.cssPrefix+"footer").attr("class",e.cssPrefix+"footer").attr("text-anchor",function(){var t="left"
return"bottom-center"===e.options.footer.location?t="middle":"bottom-right"===e.options.footer.location&&(t="left"),t}).attr("fill",function(e){return e.color}).style("font-size",function(e){return e.fontSize+"px"}).style("font-family",function(e){return e.font})},positionFooter:function(e){var t,n=e.options.footer.location,o=e.textComponents.footer.w,s=e.options.size.canvasWidth,a=e.options.size.canvasHeight,i=e.options.misc.canvasPadding
t="bottom-left"===n?i.left:"bottom-right"===n?s-o-i.right:s/2,e.svg.select("#"+e.cssPrefix+"footer").attr("x",t).attr("y",a-i.bottom)},getHeaderHeight:function(e){var t
if(e.textComponents.title.exists){var n=e.textComponents.title.h+e.options.header.titleSubtitlePadding+e.textComponents.subtitle.h
t="pie-center"===e.options.header.location?e.pieCenter.y-n/2+n:n+e.options.misc.canvasPadding.top}else if("pie-center"===e.options.header.location){var o=e.options.misc.canvasPadding.bottom+e.textComponents.footer.h
t=(e.options.size.canvasHeight-o)/2+e.options.misc.canvasPadding.top+e.textComponents.subtitle.h/2}else t=e.options.misc.canvasPadding.top+e.textComponents.subtitle.h
return t}},tt={addTooltips:function(e){var t=e.svg.insert("g").attr("class",e.cssPrefix+"tooltips")
t.selectAll("."+e.cssPrefix+"tooltip").data(e.options.data.content).enter().append("g").attr("class",e.cssPrefix+"tooltip").attr("id",function(t,n){return e.cssPrefix+"tooltip"+n}).style("opacity",0).append("rect").attr({rx:e.options.tooltips.styles.borderRadius,ry:e.options.tooltips.styles.borderRadius,x:-e.options.tooltips.styles.padding,opacity:e.options.tooltips.styles.backgroundOpacity}).style("fill",e.options.tooltips.styles.backgroundColor),t.selectAll("."+e.cssPrefix+"tooltip").data(e.options.data.content).append("text").attr("fill",function(t){return e.options.tooltips.styles.color}).style("font-size",function(t){return e.options.tooltips.styles.fontSize}).style("font-family",function(t){return e.options.tooltips.styles.font}).text(function(t,n){var o=e.options.tooltips.string
return"caption"===e.options.tooltips.type&&(o=t.caption),tt.replacePlaceholders(e,o,n,{label:t.label,value:t.value,percentage:segments.getPercentage(e,n,e.options.labels.percentage.decimalPlaces)})}),t.selectAll("."+e.cssPrefix+"tooltip rect").attr({width:function(t,n){var o=helpers.getDimensions(e.cssPrefix+"tooltip"+n)
return o.w+2*e.options.tooltips.styles.padding},height:function(t,n){var o=helpers.getDimensions(e.cssPrefix+"tooltip"+n)
return o.h+2*e.options.tooltips.styles.padding},y:function(t,n){var o=helpers.getDimensions(e.cssPrefix+"tooltip"+n)
return-(o.h/2)+1}})},showTooltip:function(e,t){var n=e.options.tooltips.styles.fadeInSpeed
tt.currentTooltip===t&&(n=1),tt.currentTooltip=t,d3.select("#"+e.cssPrefix+"tooltip"+t).transition().duration(n).style("opacity",function(){return 1}),tt.moveTooltip(e)},moveTooltip:function(e){d3.selectAll("#"+e.cssPrefix+"tooltip"+tt.currentTooltip).attr("transform",function(t){var n=d3.mouse(this.parentNode),o=n[0]+e.options.tooltips.styles.padding+2,s=n[1]-2*e.options.tooltips.styles.padding-2
return"translate("+o+","+s+")"})},hideTooltip:function(e,t){d3.select("#"+e.cssPrefix+"tooltip"+t).style("opacity",function(){return 0}),d3.select("#"+e.cssPrefix+"tooltip"+tt.currentTooltip).attr("transform",function(t,n){var o=e.options.size.canvasWidth+1e3,s=e.options.size.canvasHeight+1e3
return"translate("+o+","+s+")"})},replacePlaceholders:function(e,t,n,o){helpers.isFunction(e.options.tooltips.placeholderParser)&&e.options.tooltips.placeholderParser(n,o)
var s=function(){return function(e){var t=arguments[1]
return o.hasOwnProperty(t)?o[arguments[1]]:arguments[0]}}
return t.replace(/\{(\w+)\}/g,s(o))}},d3pie=function(e,t){if(this.element=e,"string"==typeof e){var n=e.replace(/^#/,"")
this.element=document.getElementById(n)}var o={}
extend(!0,o,defaultSettings,t),this.options=o,null!==this.options.misc.cssPrefix?this.cssPrefix=this.options.misc.cssPrefix:(this.cssPrefix="p"+_uniqueIDCounter+"_",_uniqueIDCounter++),validate.initialCheck(this)&&(d3.select(this.element).attr(_scriptName,_version),this.options.data.content=math.sortPieData(this),this.options.data.smallSegmentGrouping.enabled&&(this.options.data.content=helpers.applySmallSegmentGrouping(this.options.data.content,this.options.data.smallSegmentGrouping)),this.options.colors=helpers.initSegmentColors(this),this.totalSize=math.getTotalPieSize(this.options.data.content),_init.call(this))}
d3pie.prototype.recreate=function(){validate.initialCheck(this)&&(this.options.data.content=math.sortPieData(this),this.options.data.smallSegmentGrouping.enabled&&(this.options.data.content=helpers.applySmallSegmentGrouping(this.options.data.content,this.options.data.smallSegmentGrouping)),this.options.colors=helpers.initSegmentColors(this),this.totalSize=math.getTotalPieSize(this.options.data.content),_init.call(this))},d3pie.prototype.redraw=function(){this.element.innerHTML="",_init.call(this)},d3pie.prototype.destroy=function(){this.element.innerHTML="",d3.select(this.element).attr(_scriptName,null)},d3pie.prototype.getOpenSegment=function(){var e=this.currentlyOpenSegment
if(null!==e&&"undefined"!=typeof e){var t=parseInt(d3.select(e).attr("data-index"),10)
return{element:e,index:t,data:this.options.data.content[t]}}return null},d3pie.prototype.openSegment=function(e){e=parseInt(e,10),0>e||e>this.options.data.content.length-1||segments.openSegment(this,d3.select("#"+this.cssPrefix+"segment"+e).node())},d3pie.prototype.closeSegment=function(){var e=this.currentlyOpenSegment
e&&segments.closeSegment(this,e)},d3pie.prototype.updateProp=function(e,t){switch(e){case"header.title.text":var n=helpers.processObj(this.options,e)
helpers.processObj(this.options,e,t),d3.select("#"+this.cssPrefix+"title").html(t),(""===n&&""!==t||""!==n&&""===t)&&this.redraw()
break
case"header.subtitle.text":var o=helpers.processObj(this.options,e)
helpers.processObj(this.options,e,t),d3.select("#"+this.cssPrefix+"subtitle").html(t),(""===o&&""!==t||""!==o&&""===t)&&this.redraw()
break
case"callbacks.onload":case"callbacks.onMouseoverSegment":case"callbacks.onMouseoutSegment":case"callbacks.onClickSegment":case"effects.pullOutSegmentOnClick.effect":case"effects.pullOutSegmentOnClick.speed":case"effects.pullOutSegmentOnClick.size":case"effects.highlightSegmentOnMouseover":case"effects.highlightLuminosity":helpers.processObj(this.options,e,t)
break
default:helpers.processObj(this.options,e,t),this.destroy(),this.recreate()}}
var _init=function(){this.svg=helpers.addSVGSpace(this),this.textComponents={headerHeight:0,title:{exists:""!==this.options.header.title.text,h:0,w:0},subtitle:{exists:""!==this.options.header.subtitle.text,h:0,w:0},footer:{exists:""!==this.options.footer.text,h:0,w:0}},this.outerLabelGroupData=[],this.textComponents.title.exists&&text.addTitle(this),this.textComponents.subtitle.exists&&text.addSubtitle(this),text.addFooter(this)
var e=this
helpers.whenIdExists(this.cssPrefix+"footer",function(){text.positionFooter(e)
var t=helpers.getDimensions(e.cssPrefix+"footer")
e.textComponents.footer.h=t.h,e.textComponents.footer.w=t.w})
var t=[]
this.textComponents.title.exists&&t.push(this.cssPrefix+"title"),this.textComponents.subtitle.exists&&t.push(this.cssPrefix+"subtitle"),this.textComponents.footer.exists&&t.push(this.cssPrefix+"footer"),helpers.whenElementsExist(t,function(){if(e.textComponents.title.exists){var t=helpers.getDimensions(e.cssPrefix+"title")
e.textComponents.title.h=t.h,e.textComponents.title.w=t.w}if(e.textComponents.subtitle.exists){var n=helpers.getDimensions(e.cssPrefix+"subtitle")
e.textComponents.subtitle.h=n.h,e.textComponents.subtitle.w=n.w}if(e.textComponents.title.exists||e.textComponents.subtitle.exists){var o=0
e.textComponents.title.exists&&(o+=e.textComponents.title.h,e.textComponents.subtitle.exists&&(o+=e.options.header.titleSubtitlePadding)),e.textComponents.subtitle.exists&&(o+=e.textComponents.subtitle.h),e.textComponents.headerHeight=o}math.computePieRadius(e),math.calculatePieCenter(e),text.positionTitle(e),text.positionSubtitle(e),e.options.misc.gradient.enabled&&segments.addGradients(e),segments.create(e),labels.add(e,"inner",e.options.labels.inner.format),labels.add(e,"outer",e.options.labels.outer.format),labels.positionLabelElements(e,"inner",e.options.labels.inner.format),labels.positionLabelElements(e,"outer",e.options.labels.outer.format),labels.computeOuterLabelCoords(e),labels.positionLabelGroups(e,"outer"),labels.computeLabelLinePositions(e),e.options.labels.lines.enabled&&"none"!==e.options.labels.outer.format&&labels.addLabelLines(e),labels.positionLabelGroups(e,"inner"),labels.fadeInLabelsAndLines(e),e.options.tooltips.enabled&&tt.addTooltips(e),segments.addSegmentEventHandlers(e)})}
